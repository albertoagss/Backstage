'use strict';

var fs = require('fs-extra');
var YAML = require('js-yaml');
var lodash = require('lodash');
var path = require('path');
var chalk = require('chalk');
var Parser = require('@apidevtools/swagger-parser');
var runner = require('./runner-CRAhuK8A.cjs.js');
var paths = require('./paths-BvbxdT_S.cjs.js');
var constants = require('./constants-Dwa51b6l.cjs.js');
var helpers = require('./helpers-ja_ryoK_.cjs.js');
require('p-limit');
require('portfinder');
require('@backstage/cli-common');
require('@backstage/cli-node');
require('minimatch');

function _interopDefaultCompat (e) { return e && typeof e === 'object' && 'default' in e ? e : { default: e }; }

var fs__default = /*#__PURE__*/_interopDefaultCompat(fs);
var YAML__default = /*#__PURE__*/_interopDefaultCompat(YAML);
var chalk__default = /*#__PURE__*/_interopDefaultCompat(chalk);
var Parser__default = /*#__PURE__*/_interopDefaultCompat(Parser);

async function verify(directoryPath) {
  let openapiPath = "";
  try {
    openapiPath = await helpers.getPathToOpenApiSpec(directoryPath);
  } catch {
    return;
  }
  const yaml = YAML__default.default.load(await fs__default.default.readFile(openapiPath, "utf8"));
  await Parser__default.default.validate(lodash.cloneDeep(yaml));
  const schemaPath = path.join(directoryPath, constants.TS_SCHEMA_PATH);
  if (!await fs__default.default.pathExists(schemaPath)) {
    throw new Error(`No \`${constants.TS_SCHEMA_PATH}\` file found.`);
  }
  const schema = await import(path.resolve(path.join(directoryPath, constants.TS_MODULE)));
  if (!schema.spec) {
    throw new Error(`\`${constants.TS_SCHEMA_PATH}\` needs to have a 'spec' export.`);
  }
  if (!lodash.isEqual(schema.spec, yaml)) {
    const path$1 = path.relative(paths.paths.targetRoot, directoryPath);
    throw new Error(
      `\`${constants.YAML_SCHEMA_PATH}\` and \`${constants.TS_SCHEMA_PATH}\` do not match. Please run \`yarn backstage-repo-tools package schema openapi generate\` from '${path$1}' to regenerate \`${constants.TS_SCHEMA_PATH}\`.`
    );
  }
}
async function bulkCommand(paths = []) {
  const resultsList = await runner.runner(paths, (dir) => verify(dir));
  let failed = false;
  for (const { relativeDir, resultText } of resultsList) {
    if (resultText) {
      console.log();
      console.log(chalk__default.default.red(`OpenAPI validation failed in ${relativeDir}:`));
      console.log(resultText.trimStart());
      failed = true;
    }
  }
  if (failed) {
    process.exit(1);
  } else {
    console.log(chalk__default.default.green("Verified all files."));
  }
}

exports.bulkCommand = bulkCommand;
//# sourceMappingURL=verify-Ci5ngO-H.cjs.js.map
