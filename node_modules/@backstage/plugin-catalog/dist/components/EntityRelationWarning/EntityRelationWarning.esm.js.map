{"version":3,"file":"EntityRelationWarning.esm.js","sources":["../../../src/components/EntityRelationWarning/EntityRelationWarning.tsx"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Entity } from '@backstage/catalog-model';\nimport {\n  CatalogApi,\n  catalogApiRef,\n  useEntity,\n} from '@backstage/plugin-catalog-react';\nimport Alert from '@material-ui/lab/Alert';\nimport React from 'react';\nimport useAsync from 'react-use/esm/useAsync';\nimport Box from '@material-ui/core/Box';\nimport { ResponseErrorPanel } from '@backstage/core-components';\nimport { useApi, ApiHolder } from '@backstage/core-plugin-api';\n\nasync function getRelationWarnings(entity: Entity, catalogApi: CatalogApi) {\n  const entityRefRelations = entity.relations?.map(\n    relation => relation.targetRef,\n  );\n  if (\n    !entityRefRelations ||\n    entityRefRelations?.length < 1 ||\n    entityRefRelations.length > 1000\n  ) {\n    return [];\n  }\n\n  const relatedEntities = await catalogApi.getEntitiesByRefs({\n    entityRefs: entityRefRelations,\n    fields: ['kind', 'metadata.name', 'metadata.namespace'],\n  });\n\n  return entityRefRelations.filter(\n    (_, index) => relatedEntities.items[index] === undefined,\n  );\n}\n\n/**\n * Returns true if the given entity has relations to other entities, which\n * don't exist in the catalog\n *\n * @public\n */\nexport async function hasRelationWarnings(\n  entity: Entity,\n  context: { apis: ApiHolder },\n) {\n  const catalogApi = context.apis.get(catalogApiRef);\n  if (!catalogApi) {\n    throw new Error(`No implementation available for ${catalogApiRef}`);\n  }\n\n  const relatedEntitiesMissing = await getRelationWarnings(entity, catalogApi);\n  return relatedEntitiesMissing.length > 0;\n}\n\n/**\n * Displays a warning alert if the entity has relations to other entities, which\n * don't exist in the catalog\n *\n * @public\n */\nexport function EntityRelationWarning() {\n  const { entity } = useEntity();\n  const catalogApi = useApi(catalogApiRef);\n  const { loading, error, value } = useAsync(async () => {\n    return getRelationWarnings(entity, catalogApi);\n  }, [entity, catalogApi]);\n\n  if (error) {\n    return (\n      <Box mb={1}>\n        <ResponseErrorPanel error={error} />\n      </Box>\n    );\n  }\n\n  if (loading || !value || value.length === 0) {\n    return null;\n  }\n\n  return (\n    <>\n      <Alert severity=\"warning\">\n        This entity has relations to other entities, which can't be found in the\n        catalog. <br />\n        Entities not found are: {value.join(', ')}\n      </Alert>\n    </>\n  );\n}\n"],"names":[],"mappings":";;;;;;;;AA6BA,eAAe,mBAAA,CAAoB,QAAgB,UAAwB,EAAA;AA7B3E,EAAA,IAAA,EAAA,CAAA;AA8BE,EAAM,MAAA,kBAAA,GAAA,CAAqB,EAAO,GAAA,MAAA,CAAA,SAAA,KAAP,IAAkB,GAAA,KAAA,CAAA,GAAA,EAAA,CAAA,GAAA;AAAA,IAC3C,cAAY,QAAS,CAAA,SAAA;AAAA,GAAA,CAAA;AAEvB,EAAA,IACE,CAAC,kBACD,IAAA,CAAA,kBAAA,IAAA,IAAA,GAAA,KAAA,CAAA,GAAA,kBAAA,CAAoB,UAAS,CAC7B,IAAA,kBAAA,CAAmB,SAAS,GAC5B,EAAA;AACA,IAAA,OAAO,EAAC,CAAA;AAAA,GACV;AAEA,EAAM,MAAA,eAAA,GAAkB,MAAM,UAAA,CAAW,iBAAkB,CAAA;AAAA,IACzD,UAAY,EAAA,kBAAA;AAAA,IACZ,MAAQ,EAAA,CAAC,MAAQ,EAAA,eAAA,EAAiB,oBAAoB,CAAA;AAAA,GACvD,CAAA,CAAA;AAED,EAAA,OAAO,kBAAmB,CAAA,MAAA;AAAA,IACxB,CAAC,CAAG,EAAA,KAAA,KAAU,eAAgB,CAAA,KAAA,CAAM,KAAK,CAAM,KAAA,KAAA,CAAA;AAAA,GACjD,CAAA;AACF,CAAA;AAQsB,eAAA,mBAAA,CACpB,QACA,OACA,EAAA;AACA,EAAA,MAAM,UAAa,GAAA,OAAA,CAAQ,IAAK,CAAA,GAAA,CAAI,aAAa,CAAA,CAAA;AACjD,EAAA,IAAI,CAAC,UAAY,EAAA;AACf,IAAA,MAAM,IAAI,KAAA,CAAM,CAAmC,gCAAA,EAAA,aAAa,CAAE,CAAA,CAAA,CAAA;AAAA,GACpE;AAEA,EAAA,MAAM,sBAAyB,GAAA,MAAM,mBAAoB,CAAA,MAAA,EAAQ,UAAU,CAAA,CAAA;AAC3E,EAAA,OAAO,uBAAuB,MAAS,GAAA,CAAA,CAAA;AACzC,CAAA;AAQO,SAAS,qBAAwB,GAAA;AACtC,EAAM,MAAA,EAAE,MAAO,EAAA,GAAI,SAAU,EAAA,CAAA;AAC7B,EAAM,MAAA,UAAA,GAAa,OAAO,aAAa,CAAA,CAAA;AACvC,EAAA,MAAM,EAAE,OAAS,EAAA,KAAA,EAAO,KAAM,EAAA,GAAI,SAAS,YAAY;AACrD,IAAO,OAAA,mBAAA,CAAoB,QAAQ,UAAU,CAAA,CAAA;AAAA,GAC5C,EAAA,CAAC,MAAQ,EAAA,UAAU,CAAC,CAAA,CAAA;AAEvB,EAAA,IAAI,KAAO,EAAA;AACT,IAAA,2CACG,GAAI,EAAA,EAAA,EAAA,EAAI,qBACN,KAAA,CAAA,aAAA,CAAA,kBAAA,EAAA,EAAmB,OAAc,CACpC,CAAA,CAAA;AAAA,GAEJ;AAEA,EAAA,IAAI,OAAW,IAAA,CAAC,KAAS,IAAA,KAAA,CAAM,WAAW,CAAG,EAAA;AAC3C,IAAO,OAAA,IAAA,CAAA;AAAA,GACT;AAEA,EAAA,uBAEI,KAAA,CAAA,aAAA,CAAA,KAAA,CAAA,QAAA,EAAA,IAAA,kBAAA,KAAA,CAAA,aAAA,CAAC,KAAM,EAAA,EAAA,QAAA,EAAS,aAAU,oFAEf,kBAAA,KAAA,CAAA,aAAA,CAAC,IAAG,EAAA,IAAA,CAAA,EAAE,0BACU,EAAA,KAAA,CAAM,IAAK,CAAA,IAAI,CAC1C,CACF,CAAA,CAAA;AAEJ;;;;"}